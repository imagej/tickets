<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  
  

  
  <!-- See: http://trac.edgewall.org/wiki/TracInterfaceCustomization -->


  <head>
    <title>
      #1605 (Exception thrown when many images opened simultaneously)
     â€“ ImageJ
    </title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <link rel="search" href="/search" />
        <link rel="prev" href="/ticket/1604" title="Ticket #1604" />
        <link rel="last" href="/ticket/2043" title="Ticket #2043" />
        <link rel="help" href="/wiki/TracGuide" />
        <link rel="alternate" href="/ticket/1605?format=csv" type="text/csv" class="csv" title="Comma-delimited Text" /><link rel="alternate" href="/ticket/1605?format=tab" type="text/tab-separated-values" class="tab" title="Tab-delimited Text" /><link rel="alternate" href="/ticket/1605?format=rss" type="application/rss+xml" class="rss" title="RSS Feed" />
        <link rel="next" href="/ticket/1606" title="Ticket #1606" />
        <link rel="start" href="/wiki" />
        <link rel="stylesheet" href="trac.css" type="text/css" /><link rel="stylesheet" href="ticket.css" type="text/css" /><link rel="stylesheet" href="tracvote.css" type="text/css" />
        <link rel="first" href="/ticket/1" title="Ticket #1" />
        <link rel="shortcut icon" href="/chrome/site/imagej-16.png" type="image/png" />
        <link rel="icon" href="/chrome/site/imagej-16.png" type="image/png" />
      <link type="application/opensearchdescription+xml" rel="search" href="/search/opensearch" title="Search ImageJ" />
    <script type="text/javascript">
      var auto_preview_timeout=2.0;
      var form_token="72c9119e4e1812fa55130364";
    </script>
    <script type="text/javascript" src="/chrome/common/js/jquery.js"></script><script type="text/javascript" src="/chrome/common/js/babel.js"></script><script type="text/javascript" src="/chrome/common/js/trac.js"></script><script type="text/javascript" src="/chrome/common/js/search.js"></script><script type="text/javascript" src="/chrome/common/js/folding.js"></script><script type="text/javascript" src="/chrome/common/js/wikitoolbar.js"></script><script type="text/javascript" src="/chrome/common/js/resizer.js"></script><script type="text/javascript" src="/chrome/common/js/auto_preview.js"></script>
    <!--[if lt IE 7]>
    <script type="text/javascript" src="/chrome/common/js/ie_pre7_hacks.js"></script>
    <![endif]-->
    <script type="text/javascript">
      jQuery(document).ready(function($) {
        $("div.description").find("h1,h2,h3,h4,h5,h6").addAnchor(_("Link to this section"));
        $(".foldable").enableFolding(false, true);
        var args = {realm: "ticket", id: 1605, escape_newlines: 1}
        $("#comment").autoPreview("/wiki_render", args, function(textarea, text, rendered) {
            $("#ticketchange div.comment").html(rendered);
            if (rendered)
              $("#ticketchange").show();
            else if ($("#ticketchange ul.changes").length == 0)
              $("#ticketchange").hide();
        });
        $("#trac-comment-editor textarea").autoPreview("/wiki_render", args,
                                                       function(textarea, text, rendered) {
          var comment = $("#trac-comment-editor").next("div.comment");
          comment.html(rendered);
          if (rendered)
            comment.show();
          else
            comment.hide();
        });
        $("#modify").parent().toggleClass("collapsed");
        $(".trac-topnav a").click(function() { $("#modify").parent().removeClass("collapsed"); });
        /* only enable control elements for the currently selected action */
        var actions = $("#action input[name='action']");
        function updateActionFields() {
          actions.each(function () {
            $(this).siblings().find("*[id]").enable($(this).checked());
            $(this).siblings().filter("*[id]").enable($(this).checked());
          });
        }
        actions.click(updateActionFields);
        updateActionFields();
      });
    </script>
    <link rel="stylesheet" type="text/css" href="style.css" />
  </head>
  <body>
    <div id="main">
    <div id="content" class="ticket">
      <h1 id="trac-ticket-title">
          <a href="/ticket/1605">Ticket #1605</a>
          <span class="status">(closed defect: wontfix)</span>
      </h1>
      <div id="ticket">
  <div class="date">
    <p>Opened <a class="timeline" href="/timeline?from=2012-12-14T10%3A06%3A16-06%3A00&amp;precision=second" title="2012-12-14T10:06:16-06:00 in Timeline">7 years</a> ago</p>
    <p>Last modified <a class="timeline" href="/timeline?from=2014-08-19T11%3A12%3A14-05%3A00&amp;precision=second" title="2014-08-19T11:12:14-05:00 in Timeline">5 years</a> ago</p>
  </div>
  <h2 class="summary searchable">Exception thrown when many images opened simultaneously</h2>
  <table class="properties">
    <tr>
      <th id="h_reporter">Reported by:</th>
      <td headers="h_reporter" class="searchable">
        <a href="/query?status=!closed&amp;reporter=bdezonia">bdezonia</a>
      </td>
      <th id="h_owner">Owned by:</th>
      <td headers="h_owner">
        <a href="/query?status=!closed&amp;owner=bdezonia">bdezonia</a>
      </td>
    </tr>
    <tr>
        <th id="h_priority">
          Priority:
        </th>
        <td headers="h_priority">
              <a href="/query?status=!closed&amp;priority=major">major</a>
        </td>
        <th id="h_milestone">
          Milestone:
        </th>
        <td headers="h_milestone">
              <a class="milestone" href="/milestone/imagej2-b8-analysis">imagej2-b8-analysis</a>
        </td>
    </tr><tr>
        <th id="h_component">
          Component:
        </th>
        <td headers="h_component">
              <a href="/query?status=!closed&amp;component=Legacy+Compatibility">Legacy Compatibility</a>
        </td>
        <th id="h_version">
          Version:
        </th>
        <td headers="h_version">
              <a href="/query?status=!closed&amp;version="></a>
        </td>
    </tr><tr>
        <th id="h_severity">
          Severity:
        </th>
        <td headers="h_severity">
              <a href="/query?status=!closed&amp;severity=serious">serious</a>
        </td>
        <th id="h_keywords">
          Keywords:
        </th>
        <td headers="h_keywords" class="searchable">
        </td>
    </tr><tr>
        <th id="h_cc">
          Cc:
        </th>
        <td headers="h_cc" class="searchable">
        </td>
        <th id="h_blockedby">
          Blocked By:
        </th>
        <td headers="h_blockedby">
        </td>
    </tr><tr>
        <th id="h_blocking">
          Blocking:
        </th>
        <td headers="h_blocking">
              <a class="new" href="/ticket/1457" title="Fix obviously failing commands [analysis]">#1457</a>
        </td>
        <th>
        </th>
        <td>
        </td>
    </tr>
  </table>
  <div class="description">
    <h3 id="comment:description">
      Description
    </h3>
    <div class="searchable">
      <p>
Start IJ2. Hold down Shift Command B so that many Blobs images get opened very quickly. See that an exception is thrown in Eclipse' console. Code inspection shows this to be a weird issue where someone has likely called ImageProcessor::resetThreshold() while another thread is in ByteProcessor::setMinAndMax(). I suspect that updateImagePlusesFromDIsplays() is updating an ImagePlus that is also currently being updated by a Harmonizer in another LegacyCommand. If we locked Displays or ImagePluses as needed this issue would not arise.<br />
</p>
<p>
Uncaught exception in thread Thread[IJ1 legacy thread,6,IJ1 legacy group]<br />
java.lang.NullPointerException<br />
</p>
<blockquote>
<p>
at ij.process.ByteProcessor.setMinAndMax(ByteProcessor.java:455)<br />
at ij.ImagePlus.setDisplayRange(ImagePlus.java:2144)<br />
at imagej.legacy.translate.ColorTableHarmonizer.assignImagePlusMinMax(ColorTableHarmonizer.java:275)<br />
at imagej.legacy.translate.ColorTableHarmonizer.updateLegacyImage(ColorTableHarmonizer.java:129)<br />
at imagej.legacy.translate.Harmonizer.updateLegacyImage(Harmonizer.java:139)<br />
at imagej.legacy.plugin.LegacyCommand$LegacyCommandThread.updateImagePlusesFromDisplays(LegacyCommand.java:355)<br />
at imagej.legacy.plugin.LegacyCommand$LegacyCommandThread.run(LegacyCommand.java:187)<br />
</p>
</blockquote>

    </div>
  </div>
</div>
          

        <div>
          <h2 class="foldable">Change History</h2>
          <div id="changelog">
              <div class="change" id="trac-change-1">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:1" class="cnum">
      <a href="#comment:1">comment:1</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="/timeline?from=2012-12-14T10%3A06%3A34-06%3A00&amp;precision=second" title="2012-12-14T10:06:34-06:00 in Timeline">7 years</a> ago by bdezonia
                </h3>
                
  <ul class="changes">
    <li>
      <strong>Blocking</strong>
        <em>1563</em> added
    </li>
  </ul>
    <div class="comment searchable">
      
      
    </div>

              </div>
              <div class="change" id="trac-change-2">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:2" class="cnum">
      <a href="#comment:2">comment:2</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="/timeline?from=2012-12-14T10%3A11%3A28-06%3A00&amp;precision=second" title="2012-12-14T10:11:28-06:00 in Timeline">7 years</a> ago by bdezonia
                </h3>
                
    <div class="comment searchable">
      
      <p>
Note this issue has arisen in code that relied on the original LegacyOutputTracker ThreadLocal approach. If you use code from the legacy-tracker branch (relying on synchronized methods and tracking things by ThreadGroup) I think the problem manifests itself in a different way (due to timing). Again it is that everyone is trying to update all the ImagePluses themselves. We need to be smarter about how we make sure ImagePluses contain the latest data of a Display when a legacy plugin is launched avoiding threading issues and inefficiencies.<br />
</p>

    </div>

              </div>
              <div class="change" id="trac-change-3">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:3" class="cnum">
      <a href="#comment:3">comment:3</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="/timeline?from=2012-12-14T12%3A46%3A18-06%3A00&amp;precision=second" title="2012-12-14T12:46:18-06:00 in Timeline">7 years</a> ago by bdezonia
                </h3>
                
    <div class="comment searchable">
      
      <p>
Note this issue is different from <a class="closed ticket" href="/ticket/1606" title="defect: Access ObjectService in a thread safe manner (closed: fixed)">#1606</a><br />
</p>

    </div>

              </div>
              <div class="change" id="trac-change-4">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:4" class="cnum">
      <a href="#comment:4">comment:4</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="/timeline?from=2013-01-07T14%3A41%3A23-06%3A00&amp;precision=second" title="2013-01-07T14:41:23-06:00 in Timeline">7 years</a> ago by bdezonia
                </h3>
                
    <div class="comment searchable">
      
      <p>
Merged the legacy-output-tracker code some time ago. So the above exception is likely no longer happening. But the underlying issues still exist.<br />
</p>

    </div>

              </div>
              <div class="change" id="trac-change-5">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:5" class="cnum">
      <a href="#comment:5">comment:5</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="/timeline?from=2013-01-15T12%3A34%3A04-06%3A00&amp;precision=second" title="2013-01-15T12:34:04-06:00 in Timeline">6 years</a> ago by bdezonia
                </h3>
                
    <div class="comment searchable">
      
      <p>
The current exception is<br />
</p>
<p>
[ERROR] java.lang.NullPointerException<br />
</p>
<blockquote>
<p>
at imagej.ui.viewer.image.AbstractImageDisplayViewer.onEvent(AbstractImageDisplayViewer.java:293)<br />
at sun.reflect.GeneratedMethodAccessor21.invoke(Unknown Source)<br />
at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)<br />
at java.lang.reflect.Method.invoke(Method.java:597)<br />
at imagej.event.DefaultEventService$ProxySubscriber.onEvent(DefaultEventService.java:226)<br />
at imagej.event.DefaultEventService$ProxySubscriber.onEvent(DefaultEventService.java:1)<br />
at org.bushe.swing.event.ThreadSafeEventService.publish(ThreadSafeEventService.java:971)<br />
at imagej.event.DefaultEventBus.access$1(DefaultEventBus.java:1)<br />
at imagej.event.DefaultEventBus$1.run(DefaultEventBus.java:201)<br />
at imagej.thread.DefaultThreadService.invoke(DefaultThreadService.java:86)<br />
at imagej.event.DefaultEventBus.publishNow(DefaultEventBus.java:195)<br />
at imagej.event.DefaultEventBus.publishNow(DefaultEventBus.java:87)<br />
at imagej.event.DefaultEventService.publish(DefaultEventService.java:79)<br />
at imagej.data.display.DefaultImageCanvas.publishPanZoomEvent(DefaultImageCanvas.java:417)<br />
at imagej.data.display.DefaultImageCanvas.setPanCenter(DefaultImageCanvas.java:249)<br />
at imagej.data.display.DefaultImageCanvas.setZoomAndCenter(DefaultImageCanvas.java:317)<br />
at imagej.ui.swing.viewer.image.JHotDrawImageCanvas.sync(JHotDrawImageCanvas.java:515)<br />
at imagej.ui.swing.viewer.image.JHotDrawImageCanvas.syncCanvas(JHotDrawImageCanvas.java:456)<br />
at imagej.ui.swing.viewer.image.JHotDrawImageCanvas.componentResized(JHotDrawImageCanvas.java:296)<br />
at java.awt.AWTEventMulticaster.componentResized(AWTEventMulticaster.java:143)<br />
at java.awt.Component.processComponentEvent(Component.java:6208)<br />
at java.awt.Component.processEvent(Component.java:6162)<br />
at java.awt.Container.processEvent(Container.java:2083)<br />
at java.awt.Component.dispatchEventImpl(Component.java:4744)<br />
at java.awt.Container.dispatchEventImpl(Container.java:2141)<br />
at java.awt.Component.dispatchEvent(Component.java:4572)<br />
at java.awt.EventQueue.dispatchEventImpl(EventQueue.java:704)<br />
at java.awt.EventQueue.access$400(EventQueue.java:82)<br />
at java.awt.EventQueue$2.run(EventQueue.java:663)<br />
at java.awt.EventQueue$2.run(EventQueue.java:661)<br />
at java.security.AccessController.doPrivileged(Native Method)<br />
at java.security.AccessControlContext$1.doIntersectionPrivilege(AccessControlContext.java:87)<br />
at java.security.AccessControlContext$1.doIntersectionPrivilege(AccessControlContext.java:98)<br />
at java.awt.EventQueue$3.run(EventQueue.java:677)<br />
at java.awt.EventQueue$3.run(EventQueue.java:675)<br />
at java.security.AccessController.doPrivileged(Native Method)<br />
at java.security.AccessControlContext$1.doIntersectionPrivilege(AccessControlContext.java:87)<br />
at java.awt.EventQueue.dispatchEvent(EventQueue.java:674)<br />
at java.awt.EventDispatchThread.pumpOneEventForFilters(EventDispatchThread.java:296)<br />
at java.awt.EventDispatchThread.pumpEventsForFilter(EventDispatchThread.java:211)<br />
at java.awt.EventDispatchThread.pumpEventsForHierarchy(EventDispatchThread.java:201)<br />
at java.awt.EventDispatchThread.pumpEvents(EventDispatchThread.java:196)<br />
at java.awt.EventDispatchThread.pumpEvents(EventDispatchThread.java:188)<br />
at java.awt.EventDispatchThread.run(EventDispatchThread.java:122)<br />
</p>
</blockquote>

    </div>

              </div>
              <div class="change" id="trac-change-6">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:6" class="cnum">
      <a href="#comment:6">comment:6</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="/timeline?from=2013-01-15T12%3A56%3A52-06%3A00&amp;precision=second" title="2013-01-15T12:56:52-06:00 in Timeline">6 years</a> ago by bdezonia
                </h3>
                
    <div class="comment searchable">
      
      <p>
Exception in previous comment dispatched with commit 3e54935fc52f44b92ba5e29da6a4e745c92e684a.<br />
</p>
<p>
The first exception mentioned in the ticket description still happens and will do so until we address ticket <a class="new ticket" href="/ticket/1192" title="defect: Lock images when running legacy plugins (new)">#1192</a> (for reasons outlined above).<br />
</p>

    </div>

              </div>
              <div class="change" id="trac-change-7">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:7" class="cnum">
      <a href="#comment:7">comment:7</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="/timeline?from=2013-04-03T13%3A49%3A21-05%3A00&amp;precision=second" title="2013-04-03T13:49:21-05:00 in Timeline">6 years</a> ago by bdezonia
                </h3>
                
  <ul class="changes">
    <li>
      <strong>Priority</strong>
        changed from <em>major</em> to <em>minor</em>
    </li>
  </ul>
    <div class="comment searchable">
      
      
    </div>

              </div>
              <div class="change" id="trac-change-8">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:8" class="cnum">
      <a href="#comment:8">comment:8</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="/timeline?from=2013-04-03T13%3A50%3A39-05%3A00&amp;precision=second" title="2013-04-03T13:50:39-05:00 in Timeline">6 years</a> ago by bdezonia
                </h3>
                
  <ul class="changes">
    <li>
      <strong>Priority</strong>
        changed from <em>minor</em> to <em>major</em>
    </li>
  </ul>
    <div class="comment searchable">
      
      
    </div>

              </div>
              <div class="change" id="trac-change-9">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:9" class="cnum">
      <a href="#comment:9">comment:9</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="/timeline?from=2013-06-04T11%3A38%3A39-05%3A00&amp;precision=second" title="2013-06-04T11:38:39-05:00 in Timeline">6 years</a> ago by bdezonia
                </h3>
                
  <ul class="changes">
    <li>
      <strong>Blocking</strong>
        <em>1457</em> added; <em>1563</em> removed
    </li><li>
      <strong>Milestone</strong>
        changed from <em>imagej2-b7-ndim-data</em> to <em>imagej2-b8-analysis</em>
    </li>
  </ul>
    <div class="comment searchable">
      
      
    </div>

              </div>
              <div class="change" id="trac-change-10">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:10" class="cnum">
      <a href="#comment:10">comment:10</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="/timeline?from=2014-08-19T11%3A12%3A14-05%3A00&amp;precision=second" title="2014-08-19T11:12:14-05:00 in Timeline">5 years</a> ago by curtis
                </h3>
                
  <ul class="changes">
    <li>
      <strong>Status</strong>
        changed from <em>new</em> to <em>closed</em>
    </li><li>
      <strong>Resolution</strong>
        set to <em>wontfix</em>
    </li>
  </ul>
    <div class="comment searchable">
      
      <p>
We are no longer supporting use of ImageJ 1.x commands from modern ImageJ2 UIs, so this issue might be moot now. If similar issues arise with pure-IJ2 workflows, we can file a new issue.<br />
</p>

    </div>

              </div>
          </div>
        </div>
      <div id="help"><strong>Note:</strong> See
        <a href="/wiki/TracTickets">TracTickets</a> for help on using
        tickets.</div>
    </div>
    <div id="altlinks">
      <h3>Download in other formats:</h3>
      <ul>
        <li class="first">
          <a rel="nofollow" href="/ticket/1605?format=csv" class="csv">Comma-delimited Text</a>
        </li><li>
          <a rel="nofollow" href="/ticket/1605?format=tab" class="tab">Tab-delimited Text</a>
        </li><li class="last">
          <a rel="nofollow" href="/ticket/1605?format=rss" class="rss">RSS Feed</a>
        </li>
      </ul>
    </div>
    </div>
    <div id="footer" lang="en" xml:lang="en"><hr />
      <a id="tracpowered" href="http://trac.edgewall.org/"><img src="/chrome/common/trac_logo_mini.png" height="30" width="107" alt="Trac Powered" /></a>
      <p class="left">Powered by <a href="/about"><strong>Trac 0.12.2</strong></a><br />
        By <a href="http://www.edgewall.org/">Edgewall Software</a>.</p>
      <p class="right">Visit the ImageJ project at<br /><a href="http://developer.imagej.net/">http://developer.imagej.net/</a></p>
    </div>
  </body>
</html>
