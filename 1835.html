<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  
  

  
  <!-- See: http://trac.edgewall.org/wiki/TracInterfaceCustomization -->


  <head>
    <title>
      #1835 (Application exit relies on hack)
     – ImageJ
    </title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <link rel="search" href="/search" />
        <link rel="prev" href="/ticket/1834" title="Ticket #1834" />
        <link rel="last" href="/ticket/2043" title="Ticket #2043" />
        <link rel="help" href="/wiki/TracGuide" />
        <link rel="alternate" href="/ticket/1835?format=csv" type="text/csv" class="csv" title="Comma-delimited Text" /><link rel="alternate" href="/ticket/1835?format=tab" type="text/tab-separated-values" class="tab" title="Tab-delimited Text" /><link rel="alternate" href="/ticket/1835?format=rss" type="application/rss+xml" class="rss" title="RSS Feed" />
        <link rel="next" href="/ticket/1836" title="Ticket #1836" />
        <link rel="start" href="/wiki" />
        <link rel="stylesheet" href="/chrome/common/css/trac.css" type="text/css" /><link rel="stylesheet" href="/chrome/common/css/ticket.css" type="text/css" /><link rel="stylesheet" href="/chrome/vote/css/tracvote.css" type="text/css" />
        <link rel="first" href="/ticket/1" title="Ticket #1" />
        <link rel="shortcut icon" href="/chrome/site/imagej-16.png" type="image/png" />
        <link rel="icon" href="/chrome/site/imagej-16.png" type="image/png" />
      <link type="application/opensearchdescription+xml" rel="search" href="/search/opensearch" title="Search ImageJ" />
    <script type="text/javascript">
      var auto_preview_timeout=2.0;
      var form_token="97b17925a0fc9e4715e81b22";
    </script>
    <script type="text/javascript" src="/chrome/common/js/jquery.js"></script><script type="text/javascript" src="/chrome/common/js/babel.js"></script><script type="text/javascript" src="/chrome/common/js/trac.js"></script><script type="text/javascript" src="/chrome/common/js/search.js"></script><script type="text/javascript" src="/chrome/common/js/folding.js"></script><script type="text/javascript" src="/chrome/common/js/wikitoolbar.js"></script><script type="text/javascript" src="/chrome/common/js/resizer.js"></script><script type="text/javascript" src="/chrome/common/js/auto_preview.js"></script>
    <!--[if lt IE 7]>
    <script type="text/javascript" src="/chrome/common/js/ie_pre7_hacks.js"></script>
    <![endif]-->
    <script type="text/javascript">
      jQuery(document).ready(function($) {
        $("div.description").find("h1,h2,h3,h4,h5,h6").addAnchor(_("Link to this section"));
        $(".foldable").enableFolding(false, true);
        var args = {realm: "ticket", id: 1835, escape_newlines: 1}
        $("#comment").autoPreview("/wiki_render", args, function(textarea, text, rendered) {
            $("#ticketchange div.comment").html(rendered);
            if (rendered)
              $("#ticketchange").show();
            else if ($("#ticketchange ul.changes").length == 0)
              $("#ticketchange").hide();
        });
        $("#trac-comment-editor textarea").autoPreview("/wiki_render", args,
                                                       function(textarea, text, rendered) {
          var comment = $("#trac-comment-editor").next("div.comment");
          comment.html(rendered);
          if (rendered)
            comment.show();
          else
            comment.hide();
        });
        $("#modify").parent().toggleClass("collapsed");
        $(".trac-topnav a").click(function() { $("#modify").parent().removeClass("collapsed"); });
        /* only enable control elements for the currently selected action */
        var actions = $("#action input[name='action']");
        function updateActionFields() {
          actions.each(function () {
            $(this).siblings().find("*[id]").enable($(this).checked());
            $(this).siblings().filter("*[id]").enable($(this).checked());
          });
        }
        actions.click(updateActionFields);
        updateActionFields();
      });
    </script>
    <link rel="stylesheet" type="text/css" href="/chrome/site/style.css" />
  </head>
  <body>
    <div id="banner">
      <div id="header">
        <a id="logo" href="http://developer.imagej.net/"><img src="http://developer.imagej.net/files/imagej/logo.png" alt="ImageJ Trac" /></a>
      </div>
      <form id="search" action="/search" method="get">
        <div>
          <label for="proj-search">Search:</label>
          <input type="text" id="proj-search" name="q" size="18" value="" />
          <input type="submit" value="Search" />
        </div>
      </form>
      <div id="metanav" class="nav">
    <ul>
      <li class="first"><a href="/login">Login</a></li><li><a href="/prefs">Preferences</a></li><li><a href="/wiki/TracGuide">Help/Guide</a></li><li><a href="/about">About Trac</a></li><li class="last"><a href="/reset_password">Forgot your password?</a></li>
    </ul>
  </div>
    </div>
    <div id="mainnav" class="nav">
    <ul>
      <li class="first"><a href="/wiki">Wiki</a></li><li><a href="/timeline">Timeline</a></li><li><a href="/roadmap">Roadmap</a></li><li class="active"><a href="/report">View Tickets</a></li><li class="last"><a href="/search">Search</a></li>
    </ul>
  </div>
    <div id="main">
      <div id="ctxtnav" class="nav">
        <h2>Context Navigation</h2>
          <ul>
              <li class="first"><span id="vote" title="Vote count"><img src="/chrome/vote/aupgray.png" alt="Up-vote" /><span id="votes">+0</span><img src="/chrome/vote/adowngray.png" alt="Down-vote" /></span></li><li><span>&larr; <a class="prev" href="/ticket/1834" title="Ticket #1834">Previous Ticket</a></span></li><li><span><a class="next" href="/ticket/1836" title="Ticket #1836">Next Ticket</a> &rarr;</span></li><li class="last"><a href="/depgraph/1835">Depgraph</a></li>
          </ul>
        <hr />
      </div>
    <div id="content" class="ticket">
      <h1 id="trac-ticket-title">
          <a href="/ticket/1835">Ticket #1835</a>
          <span class="status">(closed defect: fixed)</span>
      </h1>
      <div id="ticket">
  <div class="date">
    <p>Opened <a class="timeline" href="/timeline?from=2013-04-22T14%3A35%3A44-05%3A00&amp;precision=second" title="2013-04-22T14:35:44-05:00 in Timeline">6 years</a> ago</p>
    <p>Last modified <a class="timeline" href="/timeline?from=2013-04-26T12%3A34%3A04-05%3A00&amp;precision=second" title="2013-04-26T12:34:04-05:00 in Timeline">6 years</a> ago</p>
  </div>
  <h2 class="summary searchable">Application exit relies on hack</h2>
  <table class="properties">
    <tr>
      <th id="h_reporter">Reported by:</th>
      <td headers="h_reporter" class="searchable">
        <a href="/query?status=!closed&amp;reporter=bdezonia">bdezonia</a>
      </td>
      <th id="h_owner">Owned by:</th>
      <td headers="h_owner">
        <a href="/query?status=!closed&amp;owner=bdezonia">bdezonia</a>
      </td>
    </tr>
    <tr>
        <th id="h_priority">
          Priority:
        </th>
        <td headers="h_priority">
              <a href="/query?status=!closed&amp;priority=major">major</a>
        </td>
        <th id="h_milestone">
          Milestone:
        </th>
        <td headers="h_milestone">
              <a class="closed milestone" href="/milestone/imagej2-b7-ndim-data">imagej2-b7-ndim-data</a>
        </td>
    </tr><tr>
        <th id="h_component">
          Component:
        </th>
        <td headers="h_component">
              <a href="/query?status=!closed&amp;component=Core">Core</a>
        </td>
        <th id="h_version">
          Version:
        </th>
        <td headers="h_version">
              <a href="/query?status=!closed&amp;version="></a>
        </td>
    </tr><tr>
        <th id="h_severity">
          Severity:
        </th>
        <td headers="h_severity">
              <a href="/query?status=!closed&amp;severity=serious">serious</a>
        </td>
        <th id="h_keywords">
          Keywords:
        </th>
        <td headers="h_keywords" class="searchable">
        </td>
    </tr><tr>
        <th id="h_cc">
          Cc:
        </th>
        <td headers="h_cc" class="searchable">
              <a href="/query?status=!closed&amp;cc=~curtis">curtis</a>
        </td>
        <th id="h_blockedby">
          Blocked By:
        </th>
        <td headers="h_blockedby">
        </td>
    </tr><tr>
        <th id="h_blocking">
          Blocking:
        </th>
        <td headers="h_blocking">
              <a class="closed" href="/ticket/1563" title="Fix obviously failing commands [ndim-data]">#1563</a>
        </td>
        <th>
        </th>
        <td>
        </td>
    </tr>
  </table>
  <div class="description">
    <h3 id="comment:description">
      Description
    </h3>
    <div class="searchable">
      <p>
There is a hack in the QuitProgram plugin that invokes System.exit(0). This was done because the disposal code was not quite ironed out / fully debugged. Now that we use the LegacyInjector to call context.dispose() directly (when IJ1 app clicked close in legacy mode) we need the disposal code to be more bulletproof. Find what the issues are that keep the app from closing (when the System.exit(0) is commented out in QuitProgram).<br />
</p>

    </div>
  </div>
</div>
          

        <div>
          <h2 class="foldable">Change History</h2>
          <div id="changelog">
              <div class="change" id="trac-change-1">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:1" class="cnum">
      <a href="#comment:1">comment:1</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="/timeline?from=2013-04-22T14%3A45%3A03-05%3A00&amp;precision=second" title="2013-04-22T14:45:03-05:00 in Timeline">6 years</a> ago by bdezonia
                </h3>
                
    <div class="comment searchable">
      
      <p>
I have gone over this issue a fair amount today and do not yet know the cause. I tried a number of things:<br />
</p>
<ul><li>check that all implementers of dispose() call super.dispose() if applicable
</li><li>block the 2nd user interface (SwingMDI) from initializing in case it was interfering with disposal elsewhere
</li><li>invoke disposal in separate time delayed thread in case we are having trouble disposing of services when the QUitProgram command is running (because it uses CommandService and ModuleService and indirectly the EventBus).
</li><li>generally making sure things are disposed at least once but only once
</li></ul><p>
I used jprofiler and the eclipse debugger each to see what the threads look like. Can't really get a stack trace in jprofiler of all threads. There are three (a main[?} thread, an awt event queue thread and a timer thread). I'm really running out of ideas. I know ctrueden thought it was related to the DefaultUIService but I messed with it a bit and changed order of operations within it with no effect.<br />
</p>

    </div>

              </div>
              <div class="change" id="trac-change-2">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:2" class="cnum">
      <a href="#comment:2">comment:2</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="/timeline?from=2013-04-22T16%3A04%3A54-05%3A00&amp;precision=second" title="2013-04-22T16:04:54-05:00 in Timeline">6 years</a> ago by bdezonia
                </h3>
                
    <div class="comment searchable">
      
      <p>
Apparently this is tied to the Mac OSX app menu manipulation. If you set SREEN_MENU to false in the MaxOSXPlatform you can exit the program. We need to make the platforms Disposable.<br />
</p>
<p>
(Note, I've attempted some simple permutations of setDefaultMenubar(null) and it does not work)<br />
</p>

    </div>

              </div>
              <div class="change" id="trac-change-3">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:3" class="cnum">
      <a href="#comment:3">comment:3</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="/timeline?from=2013-04-24T14%3A10%3A00-05%3A00&amp;precision=second" title="2013-04-24T14:10:00-05:00 in Timeline">6 years</a> ago by bdezonia
                </h3>
                
    <div class="comment searchable">
      
      <p>
Curtis reorganized the menu bar handling to not use the Apple EAWT extensions as they are buggy and caused issues elsewhere. This code is on the <a class="ext-link" href="https://github.com/imagej/imagej/compare/master...graceful-quit"><span class="icon"> </span>graceful-quit</a> branch.<br />
</p>
<p>
It closes correctly if you start app and then close app<br />
It closes correctly if you start app, open image (legacy or not), close image, and then close app<br />
It will not close correctly if you start app, open image (legacy or not), and then close app.<br />
</p>
<p>
I've tried a good number of things and added a few changes to the branch but can't yet determine what is still expecting events. There are JMenuItems, Menu, and ToggleButtons on the heap. Haven't determined how to release them yet though I've tried a couple of things.<br />
</p>

    </div>

                <div class="trac-lastedit ">
                  Last edited <a class="timeline" href="/timeline?from=2013-04-24T14%3A15%3A57-05%3A00&amp;precision=second" title="2013-04-24T14:15:57-05:00 in Timeline">6 years</a> ago
                      by curtis
                    (<a href="/ticket/1835?cversion=0&amp;cnum_hist=3#comment:3">previous</a>)
                    (<a href="/ticket/1835?action=comment-diff&amp;cnum=3&amp;version=1">diff</a>)
                </div>
              </div>
              <div class="change" id="trac-change-4">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:4" class="cnum">
      <a href="#comment:4">comment:4</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="/timeline?from=2013-04-25T13%3A11%3A09-05%3A00&amp;precision=second" title="2013-04-25T13:11:09-05:00 in Timeline">6 years</a> ago by bdezonia
                </h3>
                
    <div class="comment searchable">
      
      <p>
I found the issue. SwingDialogPrompt (and it's MDI cousin) were not disposing their window. Fixed on the graceful-exit branch with commits 63a93a9331636ffdd7af8b3b97e6d7f18887ee8e and cef3869e9cc84ba592aff60d856a5a09d6698e89<br />
</p>

    </div>

              </div>
              <div class="change" id="trac-change-5">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:5" class="cnum">
      <a href="#comment:5">comment:5</a>
    </span>
                          <span>follow-up:</span>
      <a href="#comment:6">↓ 6</a>
                  </span>
                  Changed <a class="timeline" href="/timeline?from=2013-04-25T13%3A12%3A46-05%3A00&amp;precision=second" title="2013-04-25T13:12:46-05:00 in Timeline">6 years</a> ago by bdezonia
                </h3>
                
  <ul class="changes">
    <li>
      <strong>Status</strong>
        changed from <em>new</em> to <em>closed</em>
    </li><li>
      <strong>Resolution</strong>
        set to <em>fixed</em>
    </li>
  </ul>
    <div class="comment searchable">
      
      <p>
Curtis, this code now works but the graceul-exit branch has a menu dispatching bug I will open as a nother ticket and assign to you. I am considering this ticket closed.<br />
</p>

    </div>

              </div>
              <div class="change" id="trac-change-6">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:6" class="cnum">
      <a href="#comment:6">comment:6</a>
    </span>
                        in reply to:
      <a href="#comment:5">↑ 5</a>
                  </span>
                  Changed <a class="timeline" href="/timeline?from=2013-04-26T12%3A34%3A04-05%3A00&amp;precision=second" title="2013-04-26T12:34:04-05:00 in Timeline">6 years</a> ago by bdezonia
                </h3>
                
    <div class="comment searchable">
      
      <p>
Replying to <a href="/ticket/1835#comment:5" title="Comment 5 for Ticket #1835">bdezonia</a>:<br />
</p>
<blockquote class="citation">
<p>
Curtis, this code now works but the graceul-exit branch has a menu dispatching bug I will open as a nother ticket and assign to you. I am considering this ticket closed.<br />
</p>
</blockquote>
<p>
Note that other ticket is <a class="new ticket" href="/ticket/1840" title="defect: Menu dispatching broken on graceful-exit branch (new)">#1840</a><br />
</p>

    </div>

              </div>
          </div>
        </div>
      <div id="help"><strong>Note:</strong> See
        <a href="/wiki/TracTickets">TracTickets</a> for help on using
        tickets.</div>
    </div>
    <div id="altlinks">
      <h3>Download in other formats:</h3>
      <ul>
        <li class="first">
          <a rel="nofollow" href="/ticket/1835?format=csv" class="csv">Comma-delimited Text</a>
        </li><li>
          <a rel="nofollow" href="/ticket/1835?format=tab" class="tab">Tab-delimited Text</a>
        </li><li class="last">
          <a rel="nofollow" href="/ticket/1835?format=rss" class="rss">RSS Feed</a>
        </li>
      </ul>
    </div>
    </div>
    <div id="footer" lang="en" xml:lang="en"><hr />
      <a id="tracpowered" href="http://trac.edgewall.org/"><img src="/chrome/common/trac_logo_mini.png" height="30" width="107" alt="Trac Powered" /></a>
      <p class="left">Powered by <a href="/about"><strong>Trac 0.12.2</strong></a><br />
        By <a href="http://www.edgewall.org/">Edgewall Software</a>.</p>
      <p class="right">Visit the ImageJ project at<br /><a href="http://developer.imagej.net/">http://developer.imagej.net/</a></p>
    </div>
  </body>
</html>
