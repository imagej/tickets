<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  
  

  
  <!-- See: http://trac.edgewall.org/wiki/TracInterfaceCustomization -->


  <head>
    <title>
      #1354 (Implement Help&gt;Start Legacy ImageJ)
     â€“ ImageJ
    </title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <link rel="stylesheet" href="trac.css" type="text/css" /><link rel="stylesheet" href="ticket.css" type="text/css" /><link rel="stylesheet" href="tracvote.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="style.css" />
  </head>
  <body>
    <div id="main">
    <div id="content" class="ticket">
      <h1 id="trac-ticket-title">
          <a href="1354.html">Ticket #1354</a>
          <span class="status">(closed enhancement: fixed)</span>
      </h1>
      <div id="ticket">
  <div class="date">
    <p>Opened 2012-07-30T10:42:21-05:00</p>
    <p>Last modified 2012-12-27T10:56:10-06:00</p>
  </div>
  <h2 class="summary searchable">Implement Help&gt;Start Legacy ImageJ</h2>
  <table class="properties">
    <tr>
      <th id="h_reporter">Reported by:</th>
      <td headers="h_reporter" class="searchable">
        dscho
      </td>
      <th id="h_owner">Owned by:</th>
      <td headers="h_owner">
        dscho
      </td>
    </tr>
    <tr>
        <th id="h_priority">
          Priority:
        </th>
        <td headers="h_priority">
              major
        </td>
        <th id="h_milestone">
          Milestone:
        </th>
        <td headers="h_milestone">
              <strike>imagej2-b6-legacy</strike>
        </td>
    </tr><tr>
        <th id="h_component">
          Component:
        </th>
        <td headers="h_component">
              Legacy Compatibility
        </td>
        <th id="h_version">
          Version:
        </th>
        <td headers="h_version">
              
        </td>
    </tr><tr>
        <th id="h_severity">
          Severity:
        </th>
        <td headers="h_severity">
              serious
        </td>
        <th id="h_keywords">
          Keywords:
        </th>
        <td headers="h_keywords" class="searchable">
        </td>
    </tr><tr>
        <th id="h_cc">
          Cc:
        </th>
        <td headers="h_cc" class="searchable">
        </td>
        <th id="h_blockedby">
          Blocked By:
        </th>
        <td headers="h_blockedby">
        </td>
    </tr><tr>
        <th id="h_blocking">
          Blocking:
        </th>
        <td headers="h_blocking">
              <a class="closed" href="1010.html" title="Full backwards compatibility with ImageJ1">#1010</a>, <a class="closed" href="1011.html" title="Robust ImageJ1 legacy layer">#1011</a>, <a class="closed" href="1016.html" title="Ensure all ImageJ1 functionality is available in ImageJ2">#1016</a>, <a class="new" href="1458.html" title="Make sure rewritten plugins fully support IJ1 functionality ...">#1458</a>, <a class="closed" href="1584.html" title="Improve legacy support [legacy]">#1584</a>
        </td>
        <th>
        </th>
        <td>
        </td>
    </tr>
  </table>
  <div class="description">
    <h3 id="comment:description">
      Description
    </h3>
    <div class="searchable">
      <p>
Even if our legacy service is already quite good and will get even better, there are probably a few legacy plugins we cannot possibly support without re-implementing them.<br />
</p>
<p>
As a work-around for people whose workflow relies on such plugins, let's implement Help&gt;Start Legacy ImageJ, which will hide all ImageJ 2.x windows, open all legacy <em>ij.ImagePlus</em> instances and show the ImageJ 1.x window.<br />
</p>
<p>
To this end, we need to inject a <em>boolean legacyMode</em> field into <em>ij.IJ</em> which our hacked ImageJ 1.x will handle to skip the ImageJ 2.x-specific special casing.<br />
</p>
<p>
It was briefly discussed whether it would make more sense to have a separate class loader run an unpatched ImageJ 1.x and convert all the images. But Curtis &amp; Johannes deemed this approach too fragile: no method could access instances of both class loaders at the same time without major (weakly typed) hackery.<br />
</p>

    </div>
  </div>
</div>
          

        <div>
          <h2 class="foldable">Change History</h2>
          <div id="changelog">
              <div class="change" id="trac-change-1">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:1" class="cnum">
      <a href="#comment:1">comment:1</a>
    </span>
                  </span>
                  Changed 2012-07-30T10:42:54-05:00 by dscho
                </h3>
                
  <ul class="changes">
    <li>
      <strong>Blocking</strong>
        <em>1339</em> added
    </li>
  </ul>
    <div class="comment searchable">
      
      
    </div>

              </div>
              <div class="change" id="trac-change-2">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:2" class="cnum">
      <a href="#comment:2">comment:2</a>
    </span>
                  </span>
                  Changed 2012-07-30T10:44:02-05:00 by dscho
                </h3>
                
  <ul class="changes">
    <li>
      <strong>Blocking</strong>
        <em>1010, 1011, 1016</em> added
    </li>
  </ul>
    <div class="comment searchable">
      
      
    </div>

              </div>
              <div class="change" id="trac-change-3">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:3" class="cnum">
      <a href="#comment:3">comment:3</a>
    </span>
                  </span>
                  Changed 2012-07-31T02:34:13-05:00 by curtis
                </h3>
                
  <ul class="changes">
    <li>
      <strong>Owner</strong>
        changed from <em>gharris</em> to <em>dscho</em>
    </li><li>
      <strong>Status</strong>
        changed from <em>new</em> to <em>assigned</em>
    </li><li>
      <strong>Milestone</strong>
        changed from <em>imagej-2.0.0-beta5</em> to <em>imagej-2.0.0-beta4</em>
    </li>
  </ul>
    <div class="comment searchable">
      
      
    </div>

              </div>
              <div class="change" id="trac-change-4">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:4" class="cnum">
      <a href="#comment:4">comment:4</a>
    </span>
                  </span>
                  Changed 2012-08-03T13:32:22-05:00 by dscho
                </h3>
                
    <div class="comment searchable">
      
      <p>
In a discussion with Barry I just realized that the changes to the javassist'ed code are a little more involved: we need to maintain the mapping between ImagePlus instances and their corresponding Dataset instances even if in legacy mode, so that the images are available when clicking the (to be added after Help&gt;Start Legacy ImageJ) Help&gt;Switch Back To ImageJ2.<br />
</p>

    </div>

              </div>
              <div class="change" id="trac-change-5">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:5" class="cnum">
      <a href="#comment:5">comment:5</a>
    </span>
                  </span>
                  Changed 2012-08-17T16:47:02-05:00 by dscho
                </h3>
                
    <div class="comment searchable">
      
      <p>
A start has been made in the 'legacy' branch. It is very much work in progress; so far, it only shows the ImageJ1 main window and the ImageJ1 ImageWindows. In the least, we need to<br />
</p>
<ul><li>hide the ImageJ2 main window
</li><li>hide the ImageJ2 image windows
</li><li>add a Help&gt;Stop Legacy Mode
</li></ul><p>
The last point is very easy: we will just look whether ImageJ1's command table already contains that entry and if not, add it to the menu and put an entry into the command table that refers to a to-be-written class.<br />
</p>
<p>
We will exploit one obscure quirk of ImageJ1: if the command table refers to a class that implements  neither ij.plugin.PlugIn nor ij.plugin.filter.PlugInFilter, it is not an error, but the class is just constructed. That allows the class to do something very dirty: call all the logic from the constructor. (This developer will feel slightly dirty about making this hack, but will make sure everything is properly documented in the Javadoc. Or maybe just bite the bullet and implement an ij.plugin.PlugIn since we depend on ij.jar anyway.)<br />
</p>
<p>
We must take pains not to execute these hacks unless the user called legacy mode, however: if we would always do it on start-up of the legacy service, headless operation would break rather badly.<br />
</p>

    </div>

              </div>
              <div class="change" id="trac-change-6">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:6" class="cnum">
      <a href="#comment:6">comment:6</a>
    </span>
                  </span>
                  Changed 2012-08-20T14:15:48-05:00 by dscho
                </h3>
                
    <div class="comment searchable">
      
      <p>
Further progress on the 'legacy' branch: all the remaining points have been addressed. But of course there are new problems:<br />
</p>
<ul><li>To be able to stop the legacy mode from the command finder, there is now a dependency on SwingUtilities#invokeLater(Runnable) in the LegacyService. Of course, this is only a work-around for an issue in the display service where it is currently assumed that we're running on the Event Dispatch Thread (this will have to be fixed properly, of course).
</li><li>The legacy service's update/create functionality was never prepared for the possibility that there might be a need <em>not</em> to show the updated/created image windows. So the whole code around holding off from displaying changes until legacy mode was terminated is currently <em>very</em> fragile.
</li></ul>
    </div>

              </div>
              <div class="change" id="trac-change-7">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:7" class="cnum">
      <a href="#comment:7">comment:7</a>
    </span>
                  </span>
                  Changed 2012-09-06T19:01:11-05:00 by dscho
                </h3>
                
  <ul class="changes">
    <li>
      <strong>Milestone</strong>
        changed from <em>imagej-2.0.0-beta4</em> to <em>imagej-2.0.0-beta5</em>
    </li>
  </ul>
    <div class="comment searchable">
      
      
    </div>

              </div>
              <div class="change" id="trac-change-8">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:8" class="cnum">
      <a href="#comment:8">comment:8</a>
    </span>
                  </span>
                  Changed 2012-09-07T11:08:56-05:00 by bdezonia
                </h3>
                
  <ul class="changes">
    <li>
      <strong>Blocking</strong>
        <em>1458</em> added; <em>1339</em> removed
    </li>
  </ul>
    <div class="comment searchable">
      
      
    </div>

              </div>
              <div class="change" id="trac-change-9">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:9" class="cnum">
      <a href="#comment:9">comment:9</a>
    </span>
                  </span>
                  Changed 2012-12-19T16:29:34-06:00 by bdezonia
                </h3>
                
  <ul class="changes">
    <li>
      <strong>Milestone</strong>
        changed from <em>imagej2-b7-ndim-data</em> to <em>imagej2-b6-legacy-undo</em>
    </li>
  </ul>
    <div class="comment searchable">
      
      
    </div>

              </div>
              <div class="change" id="trac-change-10">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:10" class="cnum">
      <a href="#comment:10">comment:10</a>
    </span>
                  </span>
                  Changed 2012-12-19T16:30:11-06:00 by bdezonia
                </h3>
                
  <ul class="changes">
    <li>
      <strong>Blocking</strong>
        <em>1584</em> added
    </li>
  </ul>
    <div class="comment searchable">
      
      
    </div>

              </div>
              <div class="change" id="trac-change-11">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:11" class="cnum">
      <a href="#comment:11">comment:11</a>
    </span>
                  </span>
                  Changed 2012-12-19T16:31:08-06:00 by bdezonia
                </h3>
                
    <div class="comment searchable">
      
      <p>
Legacy branch merged on 12-19-12.<br />
</p>

    </div>

              </div>
              <div class="change" id="trac-change-12">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:12" class="cnum">
      <a href="#comment:12">comment:12</a>
    </span>
                  </span>
                  Changed 2012-12-27T10:56:10-06:00 by curtis
                </h3>
                
  <ul class="changes">
    <li>
      <strong>Status</strong>
        changed from <em>assigned</em> to <em>closed</em>
    </li><li>
      <strong>Resolution</strong>
        set to <em>fixed</em>
    </li>
  </ul>
    <div class="comment searchable">
      
      <p>
See <a class="missing changeset" title="No default repository defined">8dba7148</a> and <a class="missing changeset" title="No default repository defined">b9b1c5fc</a> for details.<br />
</p>

    </div>

                <div class="trac-lastedit ">
                  Last edited 2012-12-27T10:57:03-06:00
                      by curtis
                </div>
              </div>
          </div>
        </div>
    </div>
    </div>
  </body>
</html>
