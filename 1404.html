<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  
  

  
  <!-- See: http://trac.edgewall.org/wiki/TracInterfaceCustomization -->


  <head>
    <title>
      #1404 (Display tracking problems exist when running legacy code from within IJ2)
     – ImageJ
    </title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <link rel="search" href="/search" />
        <link rel="prev" href="/ticket/1403" title="Ticket #1403" />
        <link rel="last" href="/ticket/2043" title="Ticket #2043" />
        <link rel="help" href="/wiki/TracGuide" />
        <link rel="alternate" href="/ticket/1404?format=csv" type="text/csv" class="csv" title="Comma-delimited Text" /><link rel="alternate" href="/ticket/1404?format=tab" type="text/tab-separated-values" class="tab" title="Tab-delimited Text" /><link rel="alternate" href="/ticket/1404?format=rss" type="application/rss+xml" class="rss" title="RSS Feed" />
        <link rel="next" href="/ticket/1405" title="Ticket #1405" />
        <link rel="start" href="/wiki" />
        <link rel="stylesheet" href="/chrome/common/css/trac.css" type="text/css" /><link rel="stylesheet" href="/chrome/common/css/ticket.css" type="text/css" /><link rel="stylesheet" href="/chrome/vote/css/tracvote.css" type="text/css" />
        <link rel="first" href="/ticket/1" title="Ticket #1" />
        <link rel="shortcut icon" href="/chrome/site/imagej-16.png" type="image/png" />
        <link rel="icon" href="/chrome/site/imagej-16.png" type="image/png" />
      <link type="application/opensearchdescription+xml" rel="search" href="/search/opensearch" title="Search ImageJ" />
    <script type="text/javascript">
      var auto_preview_timeout=2.0;
      var form_token="a176d3ed695d996eac643ef8";
    </script>
    <script type="text/javascript" src="/chrome/common/js/jquery.js"></script><script type="text/javascript" src="/chrome/common/js/babel.js"></script><script type="text/javascript" src="/chrome/common/js/trac.js"></script><script type="text/javascript" src="/chrome/common/js/search.js"></script><script type="text/javascript" src="/chrome/common/js/folding.js"></script><script type="text/javascript" src="/chrome/common/js/wikitoolbar.js"></script><script type="text/javascript" src="/chrome/common/js/resizer.js"></script><script type="text/javascript" src="/chrome/common/js/auto_preview.js"></script>
    <!--[if lt IE 7]>
    <script type="text/javascript" src="/chrome/common/js/ie_pre7_hacks.js"></script>
    <![endif]-->
    <script type="text/javascript">
      jQuery(document).ready(function($) {
        $("div.description").find("h1,h2,h3,h4,h5,h6").addAnchor(_("Link to this section"));
        $(".foldable").enableFolding(false, true);
        var args = {realm: "ticket", id: 1404, escape_newlines: 1}
        $("#comment").autoPreview("/wiki_render", args, function(textarea, text, rendered) {
            $("#ticketchange div.comment").html(rendered);
            if (rendered)
              $("#ticketchange").show();
            else if ($("#ticketchange ul.changes").length == 0)
              $("#ticketchange").hide();
        });
        $("#trac-comment-editor textarea").autoPreview("/wiki_render", args,
                                                       function(textarea, text, rendered) {
          var comment = $("#trac-comment-editor").next("div.comment");
          comment.html(rendered);
          if (rendered)
            comment.show();
          else
            comment.hide();
        });
        $("#modify").parent().toggleClass("collapsed");
        $(".trac-topnav a").click(function() { $("#modify").parent().removeClass("collapsed"); });
        /* only enable control elements for the currently selected action */
        var actions = $("#action input[name='action']");
        function updateActionFields() {
          actions.each(function () {
            $(this).siblings().find("*[id]").enable($(this).checked());
            $(this).siblings().filter("*[id]").enable($(this).checked());
          });
        }
        actions.click(updateActionFields);
        updateActionFields();
      });
    </script>
    <link rel="stylesheet" type="text/css" href="/chrome/site/style.css" />
  </head>
  <body>
    <div id="banner">
      <div id="header">
        <a id="logo" href="http://developer.imagej.net/"><img src="http://developer.imagej.net/files/imagej/logo.png" alt="ImageJ Trac" /></a>
      </div>
      <form id="search" action="/search" method="get">
        <div>
          <label for="proj-search">Search:</label>
          <input type="text" id="proj-search" name="q" size="18" value="" />
          <input type="submit" value="Search" />
        </div>
      </form>
      <div id="metanav" class="nav">
    <ul>
      <li class="first"><a href="/login">Login</a></li><li><a href="/prefs">Preferences</a></li><li><a href="/wiki/TracGuide">Help/Guide</a></li><li><a href="/about">About Trac</a></li><li class="last"><a href="/reset_password">Forgot your password?</a></li>
    </ul>
  </div>
    </div>
    <div id="mainnav" class="nav">
    <ul>
      <li class="first"><a href="/wiki">Wiki</a></li><li><a href="/timeline">Timeline</a></li><li><a href="/roadmap">Roadmap</a></li><li class="active"><a href="/report">View Tickets</a></li><li class="last"><a href="/search">Search</a></li>
    </ul>
  </div>
    <div id="main">
      <div id="ctxtnav" class="nav">
        <h2>Context Navigation</h2>
          <ul>
              <li class="first"><span id="vote" title="Vote count"><img src="/chrome/vote/aupgray.png" alt="Up-vote" /><span id="votes">+0</span><img src="/chrome/vote/adowngray.png" alt="Down-vote" /></span></li><li><span>&larr; <a class="prev" href="/ticket/1403" title="Ticket #1403">Previous Ticket</a></span></li><li><span><a class="next" href="/ticket/1405" title="Ticket #1405">Next Ticket</a> &rarr;</span></li><li class="last"><a href="/depgraph/1404">Depgraph</a></li>
          </ul>
        <hr />
      </div>
    <div id="content" class="ticket">
      <h1 id="trac-ticket-title">
          <a href="/ticket/1404">Ticket #1404</a>
          <span class="status">(closed defect: fixed)</span>
      </h1>
      <div id="ticket">
  <div class="date">
    <p>Opened <a class="timeline" href="/timeline?from=2012-08-14T14%3A51%3A57-05%3A00&amp;precision=second" title="2012-08-14T14:51:57-05:00 in Timeline">7 years</a> ago</p>
    <p>Last modified <a class="timeline" href="/timeline?from=2012-12-12T13%3A13%3A56-06%3A00&amp;precision=second" title="2012-12-12T13:13:56-06:00 in Timeline">7 years</a> ago</p>
  </div>
  <h2 class="summary searchable">Display tracking problems exist when running legacy code from within IJ2</h2>
  <table class="properties">
    <tr>
      <th id="h_reporter">Reported by:</th>
      <td headers="h_reporter" class="searchable">
        <a href="/query?status=!closed&amp;reporter=bdezonia">bdezonia</a>
      </td>
      <th id="h_owner">Owned by:</th>
      <td headers="h_owner">
        <a href="/query?status=!closed&amp;owner=bdezonia">bdezonia</a>
      </td>
    </tr>
    <tr>
        <th id="h_priority">
          Priority:
        </th>
        <td headers="h_priority">
              <a href="/query?status=!closed&amp;priority=major">major</a>
        </td>
        <th id="h_milestone">
          Milestone:
        </th>
        <td headers="h_milestone">
              <a class="closed milestone" href="/milestone/imagej2-b6-legacy">imagej2-b6-legacy</a>
        </td>
    </tr><tr>
        <th id="h_component">
          Component:
        </th>
        <td headers="h_component">
              <a href="/query?status=!closed&amp;component=Legacy+Compatibility">Legacy Compatibility</a>
        </td>
        <th id="h_version">
          Version:
        </th>
        <td headers="h_version">
              <a href="/query?status=!closed&amp;version="></a>
        </td>
    </tr><tr>
        <th id="h_severity">
          Severity:
        </th>
        <td headers="h_severity">
              <a href="/query?status=!closed&amp;severity=serious">serious</a>
        </td>
        <th id="h_keywords">
          Keywords:
        </th>
        <td headers="h_keywords" class="searchable">
        </td>
    </tr><tr>
        <th id="h_cc">
          Cc:
        </th>
        <td headers="h_cc" class="searchable">
        </td>
        <th id="h_blockedby">
          Blocked By:
        </th>
        <td headers="h_blockedby">
        </td>
    </tr><tr>
        <th id="h_blocking">
          Blocking:
        </th>
        <td headers="h_blocking">
              <a class="closed" href="/ticket/1584" title="Improve legacy support [legacy]">#1584</a>
        </td>
        <th>
        </th>
        <td>
        </td>
    </tr>
  </table>
  <div class="description">
    <h3 id="comment:description">
      Description
      <span class="lastmod" title="2012-08-14 20:05:51.041333+00:00">
        (last modified by bdezonia)
        (<a href="/ticket/1404?action=diff&amp;version=2">diff</a>)
      </span>
    </h3>
    <div class="searchable">
      <p>
Here is some IJ1 code that can cause issues (documented below):<br />
</p>
<p>
ImagePlus imp1 = IJ.openImage("<a class="ext-link" href="http://imagej.nih.gov/ij/images/blobs.gif"><span class="icon"> </span>http://imagej.nih.gov/ij/images/blobs.gif</a>");<br />
imp1.show();<br />
ImagePlus imp2 = IJ.openImage("<a class="ext-link" href="http://imagej.nih.gov/ij/images/boats.gif"><span class="icon"> </span>http://imagej.nih.gov/ij/images/boats.gif</a>");<br />
imp2.show();<br />
ImagePlus imp = IJ.getImage();<br />
IJ.selectWindow("blobs.gif");<br />
ImagePlus imp3 = IJ.getImage();<br />
ImageProcessor ip=imp3.getProcessor();<br />
imp3.hide();<br />
</p>
<p>
If this code is part of a legacy plugin that is discovered and loaded into the menus it (I believe) works fine and only the boats image is left open.<br />
</p>
<p>
If this code is part of a legacy plugin that is run via Compile and Run the blobs image also stays open (incorrect). This is because the LegacyOutputTracker puts opened/closed images into thread local sets and since Compile and Run launches another thread to run the user specified plugin there are two different sets of output/closed ImagePluses and the tracking is lost.<br />
</p>
<p>
FInally if this code is placed into an IJ2 plugin directly it behaves like the Compile and Run case. But here there is no initialization and cleanup of output/closed ImagePluses since that is part of LegacyPlugin::run() and the IJ2 plugin is decidedly not a LegacyPlugin. We should not record opened/closed info in legacy layer when code has not been invoked from within LegacyPlugin. Or we should always track ImagePlus info and even IJ2 plugins should deal with open/close/harmonize. Not great.<br />
</p>
<p>
(Note that the problems inherent in using IJ1 code in an IJ2 plugin should inform the tutorial on how to port a plugin)<br />
</p>

    </div>
  </div>
</div>
          

        <div>
          <h2 class="foldable">Change History</h2>
          <div id="changelog">
              <div class="change" id="trac-change-1">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:1" class="cnum">
      <a href="#comment:1">comment:1</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="/timeline?from=2012-08-14T14%3A53%3A43-05%3A00&amp;precision=second" title="2012-08-14T14:53:43-05:00 in Timeline">7 years</a> ago by bdezonia
                </h3>
                
  <ul class="changes">
    <li>
      <strong>Blocking</strong>
        <em>1331</em> added
    </li>
  </ul>
    <div class="comment searchable">
      
      
    </div>

              </div>
              <div class="change" id="trac-change-2">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:2" class="cnum">
      <a href="#comment:2">comment:2</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="/timeline?from=2012-08-14T15%3A05%3A51-05%3A00&amp;precision=second" title="2012-08-14T15:05:51-05:00 in Timeline">7 years</a> ago by bdezonia
                </h3>
                
  <ul class="changes">
    <li>
      <strong>Description</strong>
        modified (<a href="/ticket/1404?action=diff&amp;version=2">diff</a>)
    </li>
  </ul>
    <div class="comment searchable">
      
      
    </div>

              </div>
              <div class="change" id="trac-change-3">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:3" class="cnum">
      <a href="#comment:3">comment:3</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="/timeline?from=2012-08-14T15%3A46%3A13-05%3A00&amp;precision=second" title="2012-08-14T15:46:13-05:00 in Timeline">7 years</a> ago by bdezonia
                </h3>
                
    <div class="comment searchable">
      
      <p>
Note that with commit ef1b45b86586c57c7ee6d55b35b7b98949d8716d the closing behavior is improved here. Now Windows always close correctly. However the design of the legacy layer will not support the use of legacy IJ1 code in an IJ2 plugin. All code must go through LegacyPlugin::run() to be handled correctly. And all the thread local issues still exist for things like output ImagePluses during Compile and Run. Look into this issue more carefully.<br />
</p>

    </div>

              </div>
              <div class="change" id="trac-change-4">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:4" class="cnum">
      <a href="#comment:4">comment:4</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="/timeline?from=2012-09-04T15%3A15%3A48-05%3A00&amp;precision=second" title="2012-09-04T15:15:48-05:00 in Timeline">7 years</a> ago by bdezonia
                </h3>
                
    <div class="comment searchable">
      
      <p>
General thought: our code hacker implementation could capture the current Thread's ThreadGroup and register ImagePluses to that. Then we can avoid thread locals and bad references. And we could maybe name the ThreadGroup distinctively so that we can tell if it's from IJ1 or IJ2. Then not record anything for IJ2 threads.<br />
</p>

    </div>

              </div>
              <div class="change" id="trac-change-5">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:5" class="cnum">
      <a href="#comment:5">comment:5</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="/timeline?from=2012-09-07T11%3A18%3A41-05%3A00&amp;precision=second" title="2012-09-07T11:18:41-05:00 in Timeline">7 years</a> ago by bdezonia
                </h3>
                
  <ul class="changes">
    <li>
      <strong>Blocking</strong>
        <em>1459</em> added; <em>1331</em> removed
    </li><li>
      <strong>Milestone</strong>
        changed from <em>imagej-2.0.0-beta4</em> to <em>imagej-2.0.0-beta5</em>
    </li>
  </ul>
    <div class="comment searchable">
      
      
    </div>

              </div>
              <div class="change" id="trac-change-6">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:6" class="cnum">
      <a href="#comment:6">comment:6</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="/timeline?from=2012-12-12T13%3A12%3A33-06%3A00&amp;precision=second" title="2012-12-12T13:12:33-06:00 in Timeline">7 years</a> ago by bdezonia
                </h3>
                
  <ul class="changes">
    <li>
      <strong>Status</strong>
        changed from <em>new</em> to <em>closed</em>
    </li><li>
      <strong>Resolution</strong>
        set to <em>fixed</em>
    </li><li>
      <strong>Milestone</strong>
        changed from <em>imagej2-b7-ndim-data</em> to <em>imagej2-b6-legacy-undo</em>
    </li>
  </ul>
    <div class="comment searchable">
      
      <p>
With commit 91a61bda316343d9c7f9a59baeb7b3f022d03c3b the code hacking methods were modified to only update the legacy tracking variables when the parent thread is one derived from LegacyCommand. This allows any IJ2 plugin (that is dependent on ij-legacy) to use IJ1 structures if desired without unexpected side effects. Some IJ1 methods will do nothing (specifically the display oriented and closing oriented methods). But there is now no longer any confusion in the legacy output tracking.<br />
</p>
<p>
Note that the issue with Compile And Run hatching its own threads is still present. I will open that up as a separate ticket. Closing this one.<br />
</p>

    </div>

              </div>
              <div class="change" id="trac-change-7">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:7" class="cnum">
      <a href="#comment:7">comment:7</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="/timeline?from=2012-12-12T13%3A13%3A56-06%3A00&amp;precision=second" title="2012-12-12T13:13:56-06:00 in Timeline">7 years</a> ago by bdezonia
                </h3>
                
  <ul class="changes">
    <li>
      <strong>Blocking</strong>
        <em>1584</em> added; <em>1459</em> removed
    </li>
  </ul>
    <div class="comment searchable">
      
      
    </div>

              </div>
          </div>
        </div>
      <div id="help"><strong>Note:</strong> See
        <a href="/wiki/TracTickets">TracTickets</a> for help on using
        tickets.</div>
    </div>
    <div id="altlinks">
      <h3>Download in other formats:</h3>
      <ul>
        <li class="first">
          <a rel="nofollow" href="/ticket/1404?format=csv" class="csv">Comma-delimited Text</a>
        </li><li>
          <a rel="nofollow" href="/ticket/1404?format=tab" class="tab">Tab-delimited Text</a>
        </li><li class="last">
          <a rel="nofollow" href="/ticket/1404?format=rss" class="rss">RSS Feed</a>
        </li>
      </ul>
    </div>
    </div>
    <div id="footer" lang="en" xml:lang="en"><hr />
      <a id="tracpowered" href="http://trac.edgewall.org/"><img src="/chrome/common/trac_logo_mini.png" height="30" width="107" alt="Trac Powered" /></a>
      <p class="left">Powered by <a href="/about"><strong>Trac 0.12.2</strong></a><br />
        By <a href="http://www.edgewall.org/">Edgewall Software</a>.</p>
      <p class="right">Visit the ImageJ project at<br /><a href="http://developer.imagej.net/">http://developer.imagej.net/</a></p>
    </div>
  </body>
</html>