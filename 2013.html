<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  
  

  
  <!-- See: http://trac.edgewall.org/wiki/TracInterfaceCustomization -->


  <head>
    <title>
      #2013 (QuitProgram code needs to be changed)
     – ImageJ
    </title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <link rel="stylesheet" href="trac.css" type="text/css" /><link rel="stylesheet" href="ticket.css" type="text/css" /><link rel="stylesheet" href="tracvote.css" type="text/css" />
    <script type="text/javascript">
      var auto_preview_timeout=2.0;
      var form_token="13c2633c13605ddfe6713c7e";
    </script>
    <script type="text/javascript" src="/chrome/common/js/jquery.js"></script><script type="text/javascript" src="/chrome/common/js/babel.js"></script><script type="text/javascript" src="/chrome/common/js/trac.js"></script><script type="text/javascript" src="/chrome/common/js/search.js"></script><script type="text/javascript" src="/chrome/common/js/folding.js"></script><script type="text/javascript" src="/chrome/common/js/wikitoolbar.js"></script><script type="text/javascript" src="/chrome/common/js/resizer.js"></script><script type="text/javascript" src="/chrome/common/js/auto_preview.js"></script>
    <!--[if lt IE 7]>
    <script type="text/javascript" src="/chrome/common/js/ie_pre7_hacks.js"></script>
    <![endif]-->
    <script type="text/javascript">
      jQuery(document).ready(function($) {
        $("div.description").find("h1,h2,h3,h4,h5,h6").addAnchor(_("Link to this section"));
        $(".foldable").enableFolding(false, true);
        var args = {realm: "ticket", id: 2013, escape_newlines: 1}
        $("#comment").autoPreview("/wiki_render", args, function(textarea, text, rendered) {
            $("#ticketchange div.comment").html(rendered);
            if (rendered)
              $("#ticketchange").show();
            else if ($("#ticketchange ul.changes").length == 0)
              $("#ticketchange").hide();
        });
        $("#trac-comment-editor textarea").autoPreview("/wiki_render", args,
                                                       function(textarea, text, rendered) {
          var comment = $("#trac-comment-editor").next("div.comment");
          comment.html(rendered);
          if (rendered)
            comment.show();
          else
            comment.hide();
        });
        $("#modify").parent().toggleClass("collapsed");
        $(".trac-topnav a").click(function() { $("#modify").parent().removeClass("collapsed"); });
        /* only enable control elements for the currently selected action */
        var actions = $("#action input[name='action']");
        function updateActionFields() {
          actions.each(function () {
            $(this).siblings().find("*[id]").enable($(this).checked());
            $(this).siblings().filter("*[id]").enable($(this).checked());
          });
        }
        actions.click(updateActionFields);
        updateActionFields();
      });
    </script>
    <link rel="stylesheet" type="text/css" href="style.css" />
  </head>
  <body>
    <div id="main">
    <div id="content" class="ticket">
      <h1 id="trac-ticket-title">
          <a href="/ticket/2013">Ticket #2013</a>
          <span class="status">(closed defect: invalid)</span>
      </h1>
      <div id="ticket">
  <div class="date">
    <p>Opened <a class="timeline" href="/timeline?from=2013-10-17T14%3A41%3A56-05%3A00&amp;precision=second" title="2013-10-17T14:41:56-05:00 in Timeline">6 years</a> ago</p>
    <p>Last modified <a class="timeline" href="/timeline?from=2013-10-22T10%3A16%3A22-05%3A00&amp;precision=second" title="2013-10-22T10:16:22-05:00 in Timeline">6 years</a> ago</p>
  </div>
  <h2 class="summary searchable">QuitProgram code needs to be changed</h2>
  <table class="properties">
    <tr>
      <th id="h_reporter">Reported by:</th>
      <td headers="h_reporter" class="searchable">
        <a href="/query?status=!closed&amp;reporter=bdezonia">bdezonia</a>
      </td>
      <th id="h_owner">Owned by:</th>
      <td headers="h_owner">
        <a href="/query?status=!closed&amp;owner=curtis">curtis</a>
      </td>
    </tr>
    <tr>
        <th id="h_priority">
          Priority:
        </th>
        <td headers="h_priority">
              <a href="/query?status=!closed&amp;priority=major">major</a>
        </td>
        <th id="h_milestone">
          Milestone:
        </th>
        <td headers="h_milestone">
              <a class="milestone" href="/milestone/imagej2-b8-analysis">imagej2-b8-analysis</a>
        </td>
    </tr><tr>
        <th id="h_component">
          Component:
        </th>
        <td headers="h_component">
              <a href="/query?status=!closed&amp;component=SciJava+Common">SciJava Common</a>
        </td>
        <th id="h_version">
          Version:
        </th>
        <td headers="h_version">
              <a href="/query?status=!closed&amp;version="></a>
        </td>
    </tr><tr>
        <th id="h_severity">
          Severity:
        </th>
        <td headers="h_severity">
              <a href="/query?status=!closed&amp;severity=serious">serious</a>
        </td>
        <th id="h_keywords">
          Keywords:
        </th>
        <td headers="h_keywords" class="searchable">
        </td>
    </tr><tr>
        <th id="h_cc">
          Cc:
        </th>
        <td headers="h_cc" class="searchable">
        </td>
        <th id="h_blockedby">
          Blocked By:
        </th>
        <td headers="h_blockedby">
        </td>
    </tr><tr>
        <th id="h_blocking">
          Blocking:
        </th>
        <td headers="h_blocking">
              <a class="new" href="/ticket/1519" title="Recommended architecture changes [analysis]">#1519</a>
        </td>
        <th>
        </th>
        <td>
        </td>
    </tr>
  </table>
  <div class="description">
    <h3 id="comment:description">
      Description
    </h3>
    <div class="searchable">
      <p>
The QuitProgram plugin calls context.dispose(). However the plugin itself is using some services (such as the ThreadService to run itself) that are unhappy. They throw exceptions.<br />
</p>
<p>
The QuitProgram really needs to just publish an event that says WillBeQuitting. Some people can subscribe to it (like the ScriptEditor which may veto the WillBeQuitting event if the user cancels because a current script has not been saved). After every subscriber to the WillBeQuitting event has decided not to veto then something in SciJava actually initiates the quit (after all plugins and threads have run etc.). This will keep things from barfing on quit.<br />
</p>

    </div>
  </div>
</div>
          

        <div>
          <h2 class="foldable">Change History</h2>
          <div id="changelog">
              <div class="change" id="trac-change-1">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:1" class="cnum">
      <a href="#comment:1">comment:1</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="/timeline?from=2013-10-17T14%3A42%3A35-05%3A00&amp;precision=second" title="2013-10-17T14:42:35-05:00 in Timeline">6 years</a> ago by bdezonia
                </h3>
                
  <ul class="changes">
    <li>
      <strong>Blocking</strong>
        <em>1519</em> added
    </li>
  </ul>
    <div class="comment searchable">
      
      
    </div>

              </div>
              <div class="change" id="trac-change-2">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:2" class="cnum">
      <a href="#comment:2">comment:2</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="/timeline?from=2013-10-17T15%3A04%3A07-05%3A00&amp;precision=second" title="2013-10-17T15:04:07-05:00 in Timeline">6 years</a> ago by bdezonia
                </h3>
                
    <div class="comment searchable">
      
      <p>
See this thread (jumping into middle) for some more info:<br />
</p>
<p>
<a class="ext-link" href="http://imagej.net/pipermail/imagej-devel/2013-October/001783.html"><span class="icon"> </span>http://imagej.net/pipermail/imagej-devel/2013-October/001783.html</a><br />
</p>
<p>
And a little more background here:<br />
</p>
<p>
<a class="ext-link" href="https://github.com/scijava/scijava-common/pull/14"><span class="icon"> </span>https://github.com/scijava/scijava-common/pull/14</a><br />
</p>

    </div>

              </div>
              <div class="change" id="trac-change-3">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:3" class="cnum">
      <a href="#comment:3">comment:3</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="/timeline?from=2013-10-22T09%3A51%3A38-05%3A00&amp;precision=second" title="2013-10-22T09:51:38-05:00 in Timeline">6 years</a> ago by curtis
                </h3>
                
  <ul class="changes">
    <li>
      <strong>Status</strong>
        changed from <em>new</em> to <em>closed</em>
    </li><li>
      <strong>Resolution</strong>
        set to <em>invalid</em>
    </li>
  </ul>
    <div class="comment searchable">
      
      <p>
It is not necessary to change <tt>QuitProgram</tt> in order to avoid exceptions with <tt>ThreadService</tt>. I have <a class="ext-link" href="https://github.com/scijava/scijava-common/commit/e24e62480525a8c0fc30f0f1b0b2983563733a34"><span class="icon"> </span>fixed the DefaultThreadService</a> so that the problem no longer occurs.<br />
</p>
<p>
However, I do think there is some merit to making quits vetoable. We should consider how the API for that should work. I filed a new ticket <a class="new ticket" href="/ticket/2016" title="feature: Make quitting vetoable (new)">#2016</a> for this feature.<br />
</p>

    </div>

                <div class="trac-lastedit ">
                  Last edited <a class="timeline" href="/timeline?from=2013-10-22T09%3A51%3A53-05%3A00&amp;precision=second" title="2013-10-22T09:51:53-05:00 in Timeline">6 years</a> ago
                      by curtis
                    (<a href="/ticket/2013?cversion=0&amp;cnum_hist=3#comment:3">previous</a>)
                    (<a href="/ticket/2013?action=comment-diff&amp;cnum=3&amp;version=1">diff</a>)
                </div>
              </div>
              <div class="change" id="trac-change-4">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:4" class="cnum">
      <a href="#comment:4">comment:4</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="/timeline?from=2013-10-22T10%3A01%3A57-05%3A00&amp;precision=second" title="2013-10-22T10:01:57-05:00 in Timeline">6 years</a> ago by bdezonia
                </h3>
                
    <div class="comment searchable">
      
      <p>
I think this fix is okay but might not be necessary if <a class="closed ticket" href="/ticket/2014" title="defect: Verify that services dispose in similar order to initialization (closed: moved)">#2014</a> is addressed correctly. Without fixing <a class="closed ticket" href="/ticket/2014" title="defect: Verify that services dispose in similar order to initialization (closed: moved)">#2014</a> behavior can be unpredictable for any services with dependencies. In general when the ThreadService is disposing all services that could actually use the ThreadService should already be gone. I guess a running plugin can try to launch a thread after the context is disposed but that seems like an invalid action to protect against.<br />
</p>

    </div>

              </div>
              <div class="change" id="trac-change-5">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:5" class="cnum">
      <a href="#comment:5">comment:5</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="/timeline?from=2013-10-22T10%3A04%3A41-05%3A00&amp;precision=second" title="2013-10-22T10:04:41-05:00 in Timeline">6 years</a> ago by curtis
                </h3>
                
    <div class="comment searchable">
      
      <p>
I agree that <a class="closed ticket" href="/ticket/2014" title="defect: Verify that services dispose in similar order to initialization (closed: moved)">#2014</a> also should get fixed. However, regardless of whether the disposal order is fixed, it is still possible for something to retain a handle on a <tt>ThreadService</tt> and then try to <tt>run</tt> something after context disposal has occurred. So I think the change to <tt>DefaultThreadService</tt> was required anyway too.<br />
</p>

    </div>

              </div>
              <div class="change" id="trac-change-6">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:6" class="cnum">
      <a href="#comment:6">comment:6</a>
    </span>
                  </span>
                  Changed <a class="timeline" href="/timeline?from=2013-10-22T10%3A16%3A22-05%3A00&amp;precision=second" title="2013-10-22T10:16:22-05:00 in Timeline">6 years</a> ago by bdezonia
                </h3>
                
    <div class="comment searchable">
      
      <p>
Yes that is what I said too. If it is not an invalid state to use services after disposal then every service should follow DefaultThreadService's pattern.<br />
</p>

    </div>

              </div>
          </div>
        </div>
      <div id="help"><strong>Note:</strong> See
        <a href="/wiki/TracTickets">TracTickets</a> for help on using
        tickets.</div>
    </div>
    <div id="altlinks">
      <h3>Download in other formats:</h3>
      <ul>
        <li class="first">
          <a rel="nofollow" href="/ticket/2013?format=csv" class="csv">Comma-delimited Text</a>
        </li><li>
          <a rel="nofollow" href="/ticket/2013?format=tab" class="tab">Tab-delimited Text</a>
        </li><li class="last">
          <a rel="nofollow" href="/ticket/2013?format=rss" class="rss">RSS Feed</a>
        </li>
      </ul>
    </div>
    </div>
    <div id="footer" lang="en" xml:lang="en"><hr />
      <a id="tracpowered" href="http://trac.edgewall.org/"><img src="/chrome/common/trac_logo_mini.png" height="30" width="107" alt="Trac Powered" /></a>
      <p class="left">Powered by <a href="/about"><strong>Trac 0.12.2</strong></a><br />
        By <a href="http://www.edgewall.org/">Edgewall Software</a>.</p>
      <p class="right">Visit the ImageJ project at<br /><a href="http://developer.imagej.net/">http://developer.imagej.net/</a></p>
    </div>
  </body>
</html>
