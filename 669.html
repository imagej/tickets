<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  
  

  
  <!-- See: http://trac.edgewall.org/wiki/TracInterfaceCustomization -->


  <head>
    <title>
      #669 (IJ2 seems to be holding onto memory)
     â€“ ImageJ
    </title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <link rel="stylesheet" href="trac.css" type="text/css" /><link rel="stylesheet" href="ticket.css" type="text/css" /><link rel="stylesheet" href="tracvote.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="style.css" />
  </head>
  <body>
    <div id="main">
    <div id="content" class="ticket">
      <h1 id="trac-ticket-title">
          <a href="/ticket/669">Ticket #669</a>
          <span class="status">(closed defect: fixed)</span>
      </h1>
      <div id="ticket">
  <div class="date">
    <p>Opened 2011-07-08T17:04:18-05:00</p>
    <p>Last modified 2011-07-14T14:27:57-05:00</p>
  </div>
  <h2 class="summary searchable">IJ2 seems to be holding onto memory</h2>
  <table class="properties">
    <tr>
      <th id="h_reporter">Reported by:</th>
      <td headers="h_reporter" class="searchable">
        bdezonia
      </td>
      <th id="h_owner">Owned by:</th>
      <td headers="h_owner">
        bdezonia
      </td>
    </tr>
    <tr>
        <th id="h_priority">
          Priority:
        </th>
        <td headers="h_priority">
              major
        </td>
        <th id="h_milestone">
          Milestone:
        </th>
        <td headers="h_milestone">
              <a class="closed milestone" href="/milestone/biweekly-2011%3A%20Jul-05%20to%20Jul-15">biweekly-2011: Jul-05 to Jul-15</a>
        </td>
    </tr><tr>
        <th id="h_component">
          Component:
        </th>
        <td headers="h_component">
              Legacy Compatibility
        </td>
        <th id="h_version">
          Version:
        </th>
        <td headers="h_version">
              
        </td>
    </tr><tr>
        <th id="h_severity">
          Severity:
        </th>
        <td headers="h_severity">
              serious
        </td>
        <th id="h_keywords">
          Keywords:
        </th>
        <td headers="h_keywords" class="searchable">
        </td>
    </tr><tr>
        <th id="h_cc">
          Cc:
        </th>
        <td headers="h_cc" class="searchable">
        </td>
        <th id="h_blockedby">
          Blocked By:
        </th>
        <td headers="h_blockedby">
        </td>
    </tr><tr>
        <th id="h_blocking">
          Blocking:
        </th>
        <td headers="h_blocking">
        </td>
        <th>
        </th>
        <td>
        </td>
    </tr>
  </table>
  <div class="description">
    <h3 id="comment:description">
      Description
    </h3>
    <div class="searchable">
      <p>
After running a while (lots of Stack to Images runs) IJ2 craps out with an out of memory issue.<br />
</p>

    </div>
  </div>
</div>
          

        <div>
          <h2 class="foldable">Change History</h2>
          <div id="changelog">
              <div class="change" id="trac-change-1">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:1" class="cnum">
      <a href="#comment:1">comment:1</a>
    </span>
                  </span>
                  Changed 2011-07-12T15:00:17-05:00 by bdezonia
                </h3>
                
    <div class="comment searchable">
      
      <p>
Found one memory leak in SwingDisplayWindow. Fixed in b273a2e45967134019d41378eb083cd649cfcdb7.<br />
</p>
<p>
However you can get memory issues if you do this repeatedly:<br />
</p>
<blockquote>
<p>
Open Organ Of Corti<br />
</p>
</blockquote>
<dl class="wiki"><dt>Image</dt><dd>Stacks :: Delete Data (12 Z's)
</dd><dt>Image</dt><dd>Stacks :: Stack To Images
Close all open windows
</dd></dl>

    </div>

              </div>
              <div class="change" id="trac-change-2">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:2" class="cnum">
      <a href="#comment:2">comment:2</a>
    </span>
                  </span>
                  Changed 2011-07-12T15:02:03-05:00 by bdezonia
                </h3>
                
    <div class="comment searchable">
      
      <p>
The memory issues do not cause an exception. But hatching new windows by the plugin slows more and more until its glacial. Closing these windows then will complain about memory issues.<br />
</p>

    </div>

              </div>
              <div class="change" id="trac-change-3">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:3" class="cnum">
      <a href="#comment:3">comment:3</a>
    </span>
                  </span>
                  Changed 2011-07-12T15:13:24-05:00 by bdezonia
                </h3>
                
    <div class="comment searchable">
      
      <p>
Sequence to repeat was poorly formatted.<br />
</p>
<p>
To repeat error do:<br />
</p>
<p>
Open Organ Of Corti<br />
</p>
<p>
Image Stacks :: Delete Data (12 Z's) <br />
Image Stacks :: Stack To Images<br />
Close all open windows<br />
</p>

    </div>

              </div>
              <div class="change" id="trac-change-4">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:4" class="cnum">
      <a href="#comment:4">comment:4</a>
    </span>
                  </span>
                  Changed 2011-07-12T15:31:43-05:00 by bdezonia
                </h3>
                
    <div class="comment searchable">
      
      <p>
A simpler experiment<br />
</p>
<ul><li>repeatedly run and close Help About ImageJ (IJ1)
</li><li>notice that allocated memory climbs and climbs
</li></ul>
    </div>

              </div>
              <div class="change" id="trac-change-5">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:5" class="cnum">
      <a href="#comment:5">comment:5</a>
    </span>
                  </span>
                  Changed 2011-07-13T13:16:21-05:00 by bdezonia
                </h3>
                
    <div class="comment searchable">
      
      <p>
Found that the majority of leaked memory is JMenuItems (on the Mac each window has its own menu of JMenuItems) and int[] (position and extent variables I think).<br />
</p>
<p>
To handle int[] work on ticket about minimizing creation of int[] via precreation and passing into routines. Not sure why they are never getting reclaimed. Imglib issue maybe?<br />
</p>
<p>
To handle JMenuItem issue tried making a call to dispose() when Window closes. Doesn't seem to fix thing. May need to set menu to null first which would be a bug workaround.<br />
</p>

    </div>

              </div>
              <div class="change" id="trac-change-6">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:6" class="cnum">
      <a href="#comment:6">comment:6</a>
    </span>
                  </span>
                  Changed 2011-07-13T17:21:21-05:00 by bdezonia
                </h3>
                
    <div class="comment searchable">
      
      <p>
Found the memory leak and have put in a temporary fix in SwingImageDIsplay::close(). See 7c98f9e1b79cec6e009073d01f5ead6bc1ae33af.<br />
</p>
<p>
The test for this bug is:<br />
File New Hyperstack 8-bit 300x200x10<br />
Stack To Images<br />
Close all images<br />
Using JConsole run GC and notice memory returns to where it was.<br />
</p>
<p>
Used Eclipse Memory Analyzer to hunt for leaks.<br />
</p>

    </div>

              </div>
              <div class="change" id="trac-change-7">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:7" class="cnum">
      <a href="#comment:7">comment:7</a>
    </span>
                  </span>
                  Changed 2011-07-14T11:08:16-05:00 by bdezonia
                </h3>
                
    <div class="comment searchable">
      
      <p>
Improved fix (see b77af4ce959a85df7d523291d8a0f39eb0caae5c).<br />
</p>
<p>
There are still the original byte[] data and the associated int[] display data left around. Will tackle that next.<br />
</p>

    </div>

              </div>
              <div class="change" id="trac-change-8">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:8" class="cnum">
      <a href="#comment:8">comment:8</a>
    </span>
                  </span>
                  Changed 2011-07-14T11:58:38-05:00 by bdezonia
                </h3>
                
    <div class="comment searchable">
      
      <p>
Also it seems there are hundreds of int<a class="missing changeset" title="No default repository defined">[256]</a>'s left around. ColorTable8's I'd say.<br />
</p>

    </div>

              </div>
              <div class="change" id="trac-change-9">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:9" class="cnum">
      <a href="#comment:9">comment:9</a>
    </span>
                  </span>
                  Changed 2011-07-14T12:13:38-05:00 by bdezonia
                </h3>
                
    <div class="comment searchable">
      
      <p>
if open new HyperStack of 10 8-bit 300x200 slices the memory analyzer shows about 400 int<a class="missing changeset" title="No default repository defined">[256]</a>'s unreclaimed by garbage collector.<br />
</p>

    </div>

              </div>
              <div class="change" id="trac-change-10">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:10" class="cnum">
      <a href="#comment:10">comment:10</a>
    </span>
                  </span>
                  Changed 2011-07-14T14:27:57-05:00 by bdezonia
                </h3>
                
  <ul class="changes">
    <li>
      <strong>Status</strong>
        changed from <em>new</em> to <em>closed</em>
    </li><li>
      <strong>Resolution</strong>
        set to <em>fixed</em>
    </li>
  </ul>
    <div class="comment searchable">
      
      <p>
Fixed all known memory leaks in 93b146572a7afa2a109415c1669f60ada5743a40, 2086628b52b400c3754002b6ac32e64ac7bc9244, 52a06860d77807af74a26cb9c9876841e511c501, and 013bc9f9001d5c3e20e6422fe0cc044b1271a29c.<br />
</p>
<p>
There is some question as to why so many ColorTable8's are getting created. Maybe we should investigate.<br />
</p>

    </div>

              </div>
          </div>
        </div>
    </div>
    <div id="altlinks">
      <h3>Download in other formats:</h3>
      <ul>
        <li class="first">
          <a rel="nofollow" href="/ticket/669?format=csv" class="csv">Comma-delimited Text</a>
        </li><li>
          <a rel="nofollow" href="/ticket/669?format=tab" class="tab">Tab-delimited Text</a>
        </li><li class="last">
          <a rel="nofollow" href="/ticket/669?format=rss" class="rss">RSS Feed</a>
        </li>
      </ul>
    </div>
    </div>
    <div id="footer" lang="en" xml:lang="en"><hr />
      <a id="tracpowered" href="http://trac.edgewall.org/"><img src="/chrome/common/trac_logo_mini.png" height="30" width="107" alt="Trac Powered" /></a>
      <p class="left">Powered by <a href="/about"><strong>Trac 0.12.2</strong></a><br />
        By <a href="http://www.edgewall.org/">Edgewall Software</a>.</p>
      <p class="right">Visit the ImageJ project at<br /><a href="http://developer.imagej.net/">http://developer.imagej.net/</a></p>
    </div>
  </body>
</html>
